<!DOCTYPE html>
<html>
  <head>
    <!-- BEGIN Pre-requisites -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script
      src="https://apis.google.com/js/client:platform.js?onload=start"
      async
      defer
    ></script>
    <!-- END Pre-requisites -->
    <!-- Continuing the <head> section -->
    <script>
      function start() {
        gapi.load("auth2", function () {
          auth2 = gapi.auth2.init({
            client_id:
              "843176206519-8d3743n21i6tqdv6sdadi3b2b1f9hjb7.apps.googleusercontent.com",
            // Scopes to request in addition to 'profile' and 'email'
            scope: "openid email",
            cookiepolicy: "single_host_origin",
          });
        });
      }
    </script>
  </head>
  <body>
    <!-- Add where you want your sign-in button to render -->
    <!-- Use an image that follows the branding guidelines in a real app -->
    <!-- TODO: Use alternate approach in: https://developers.google.com/identity/sign-in/web/build-button -->
    <button id="signinButton">Sign in with Google</button>
    <script>
      $("#signinButton").click(function () {
        // signInCallback defined in step 6.
        auth2.grantOfflineAccess().then(signInCallback);
      });
    </script>

    <!-- Last part of BODY element in file index.html -->
    <script>
      function signInCallback(authResult) {
        $.ajaxSetup({
          crossDomain: true,
          xhrFields: {
            withCredentials: true,
          },
        });
        if (authResult["code"]) {
          // Sample one-time code 4/zgHSw15OILvuhwvDf7MklSXji5bph7LifcFXk296gdDEqo8g97SrVnYKcABdl9EMZA0Sunzzh5FZ8z-Pyrc4SFw
          // Hide the sign-in button now that the user is authorized, for example:
          $("#signinButton").attr("style", "display: none");

          // Send the code to the server
          $.ajax({
            type: "POST",
            url: "/gconnect?state={{STATE}}",
            xhrFields: {
              withCredentials: true,
            },
            processData: false,
            data: authResult["code"],
            contentType: "application/octet-stream; charset=utf-8",
            // Always include an `X-Requested-With` header in every AJAX request,
            // to protect against CSRF attacks.
            headers: {
              "Content-Type": "application/octet-stream; charset=utf-8",
            },
            success: function (result) {
              // Handle or verify the server response.
              if (result) {
                $("#result").html(
                  "Login Successful!</br>" + result + "</br>Redirecting..."
                );
                setTimeout(function () {
                  window.location.href = "/restaurant";
                }, 4000);
              } else {
                $("#result").html(
                  "Failed to make a server-side call. Check your configuration and console."
                );
              }
            },
          });
        } else {
          // There was an error.
        }
      }
    </script>
    <div id="result"></div>
  </body>
</html>
